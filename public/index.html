<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ–°å¯å¤§å…¬å‹™è»Šé ç´„</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe 0%, #f3f4f6 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1f2937;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-size: 16px;
    }

    .container {
      max-width: 90vw;
      margin: 2vh auto;
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, opacity 0.5s ease;
      opacity: 0;
    }

    .container.fade-in {
      opacity: 1;
      transform: translateY(0);
    }

    .container:hover {
      transform: translateY(-3px);
    }

    h2, h3 {
      color: #3b82f6;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    .form-label {
      font-weight: 500;
      color: #4b5563;
      font-size: 0.9rem;
    }

    .form-control, .form-select, textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      transition: all 0.3s ease;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.05);
      font-size: 0.9rem;
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    .form-control:focus, .form-select:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 6px rgba(59, 130, 246, 0.3);
      transform: scale(1.02);
      outline: none;
    }

    .btn-primary {
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      font-size: 0.9rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: #6b7280;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      font-size: 0.9rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-secondary:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .btn-danger {
      background: #ef4444;
      border: none;
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
      font-weight: 500;
      font-size: 0.85rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-danger:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .calendar-container {
      max-width: 90vw;
      margin: 2vh auto;
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: opacity 0.5s ease;
      opacity: 0;
    }

    .calendar-container.fade-in {
      opacity: 1;
    }

    #calendar {
      margin-top: 1rem;
      font-size: 0.9rem;
      overflow: hidden;
    }

    .fc-daygrid-day {
      border-radius: 8px;
      transition: filter 0.2s ease, transform 0.2s ease;
      position: relative;
    }

    .fc-daygrid-day.bg-booked {
      border: 2px solid #f97316;
    }

    .fc-daygrid-day.bg-booked .fc-daygrid-day-frame {
      background: #f97316 !important;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      padding: 2px;
    }

    .fc-daygrid-day.available .fc-daygrid-day-frame {
      background: #ffffff !important;
      border-radius: 8px;
    }

    .fc-daygrid-day.today {
      border: 3px solid #3b82f6;
    }

    .fc-daygrid-day.bg-booked .fc-daygrid-day-frame::after {
      content: 'ğŸš—';
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      opacity: 0.8;
      color: #ffffff;
      animation: float 2s ease-in-out infinite;
    }

    .fc-daygrid-day.bg-booked.long-booking .fc-daygrid-day-frame::after {
      content: 'ğŸšŒ';
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      opacity: 0.8;
      color: #ffffff;
      animation: float 2s ease-in-out infinite;
    }

    .fc-daygrid-day:hover {
      filter: brightness(1.1);
      cursor: pointer;
    }

    .fc-daygrid-day:active {
      animation: clickScale 0.2s ease;
    }

    .fc-daygrid-day-number {
      font-weight: 500;
      color: #1f2937;
      font-size: 0.85rem;
    }

    .fc-daygrid-day-frame {
      border-radius: 8px;
      min-height: 50px;
      position: relative;
    }

    .fc-button {
      background: #3b82f6 !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 0.4rem 0.8rem !important;
      font-weight: 500 !important;
      font-size: 0.85rem !important;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease !important;
    }

    .fc-button:hover {
      background: #2563eb !important;
      transform: scale(1.05) !important;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
    }

    .fc-button:active {
      animation: pulse 0.3s ease !important;
    }

    .fc-toolbar-title {
      font-size: 1rem !important;
      color: #1f2937;
    }

    .no-bookings {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }

    .no-bookings svg {
      width: 2.5rem;
      height: 2.5rem;
      fill: #6b7280;
      margin-bottom: 0.5rem;
    }

    .no-bookings p {
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 1rem;
      display: none;
      color: #3b82f6;
      font-size: 0.9rem;
    }

    #bookings-list {
      padding: 1rem;
    }

    .booking-card {
      display: flex;
      align-items: center;
      background: #f9fafb;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 0.8rem;
      transition: background 0.2s ease;
      gap: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      animation: slideInRight 0.5s ease forwards;
    }

    .booking-card:hover {
      background: #f3f4f6;
    }

    .booking-info {
      flex: 1;
      display: flex;
      flex-direction: row;
      gap: 1rem;
      font-size: 0.85rem;
      color: #1f2937;
      align-items: center;
    }

    .booking-info div {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      min-width: 80px;
      flex: 1;
    }

    .booking-info svg {
      width: 1rem;
      height: 1rem;
      fill: #3b82f6;
    }

    .cancel-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .cancel-btn:active {
      animation: pulse 0.3s ease;
    }

    .modal-content {
      border-radius: 12px;
      border: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      animation: slideInDown 0.3s ease;
    }

    .modal-header {
      background: #3b82f6;
      color: #ffffff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    .modal-title {
      font-weight: 500;
      font-size: 1rem;
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      border-top: none;
      padding: 0.8rem;
    }

    .modal-footer .btn {
      font-size: 0.85rem;
    }

    .timeline-container {
      margin: 1rem 0;
      padding: 0.5rem;
      background: #f9fafb;
      border-radius: 8px;
      position: relative;
      height: 80px;
      animation: slideInRight 0.5s ease forwards;
    }

    .timeline {
      position: relative;
      height: 100%;
      border-bottom: 1px solid #d1d5db;
    }

    .timeline-ticks {
      display: flex;
      justify-content: space-between;
      position: absolute;
      top: -20px;
      width: 100%;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .timeline-tick {
      text-align: center;
      width: 7.69%; /* 100% / 13 hours */
    }

    .timeline-bar {
      position: absolute;
      height: 20px;
      background: #3b82f6;
      border-radius: 4px;
      top: 20px;
      display: flex;
      align-items: center;
      padding: 0 5px;
      color: #ffffff;
      font-size: 0.7rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      animation: growWidth 1s ease-in-out forwards;
      width: 0; /* åˆå§‹å¯¬åº¦ç‚º 0 */
    }

    .timeline-bar:hover {
      background: #2563eb;
      transform: scale(1.02);
    }

    /* è³ªæ„ŸæˆåŠŸè¨Šæ¯æ¨£å¼ */
    .success-message {
      display: none;
      background-color: #F8F1E9; /* è±¡ç‰™ç™½èƒŒæ™¯ */
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      color: #333333; /* æ·±ç°æ–‡å­— */
      font-size: 0.9rem;
      font-family: 'Georgia', serif;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-top: 15px;
      border-left: 4px solid #D4A373; /* é‡‘è‰²é‚Šæ¡† */
      --animate-duration: 0.5s; /* åŠ å¿«å‹•ç•«é€Ÿåº¦ */
    }

    .elegant-text {
      font-style: italic;
      letter-spacing: 0.5px;
    }

    /* å‹•ç•«å®šç¾© */
    @keyframes slideIn {
      from {
        transform: translateX(50px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes clickScale {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(0.95);
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes float {
      0% {
        transform: translateX(-50%);
      }
      50% {
        transform: translate(-50%, -8px);
      }
      100% {
        transform: translateX(-50%);
      }
    }

    @keyframes growWidth {
      from {
        width: 0;
      }
      to {
        width: var(--final-width); /* ä½¿ç”¨ CSS è®Šé‡ä¾†è¨­ç½®æœ€çµ‚å¯¬åº¦ */
      }
    }

    /* æŒ‰éˆ•é»æ“Šå‹•ç•« */
    .btn-primary:active, .btn-secondary:active, .btn-danger:active {
      animation: pulse 0.3s ease;
    }

    /* å‹•ç•«é€Ÿåº¦æ§åˆ¶ */
    .animate__animated {
      --animate-duration: 0.5s;
    }

    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      .container, .calendar-container {
        max-width: 95vw;
        margin: 1.5vh auto;
        padding: 1.5rem;
      }

      h2, h3 {
        font-size: 1.3rem;
      }

      .form-label {
        font-size: 0.85rem;
      }

      .form-control, .form-select, textarea {
        font-size: 0.85rem;
        padding: 0.4rem;
      }

      .btn-primary, .btn-secondary, .btn-danger {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }

      .success-message {
        font-size: 0.85rem;
        padding: 12px;
      }

      #calendar {
        font-size: 0.8rem;
      }

      .fc-daygrid-day-frame {
        min-height: 40px;
      }

      .fc-daygrid-day-number {
        font-size: 0.75rem;
      }

      .fc-daygrid-day.bg-booked .fc-daygrid-day-frame::after,
      .fc-daygrid-day.bg-booked.long-booking .fc-daygrid-day-frame::after {
        font-size: 1rem;
      }

      .fc-button {
        padding: 0.3rem 0.6rem !important;
        font-size: 0.8rem !important;
      }

      .fc-toolbar-title {
        font-size: 0.9rem !important;
      }

      .modal-dialog {
        margin: 0.5rem;
        max-width: 95vw;
      }

      .modal-body {
        padding: 0.8rem;
      }

      .booking-info {
        font-size: 0.8rem;
        flex-wrap: wrap;
      }

      .booking-info div {
        min-width: 100px;
        flex: 1 1 45%;
      }

      .cancel-btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
      }

      .timeline-container {
        height: 60px;
      }

      .timeline-ticks {
        font-size: 0.7rem;
      }

      .timeline-bar {
        height: 16px;
        font-size: 0.65rem;
      }

      .animate__animated {
        --animate-duration: 0.4s; /* å°è¢å¹•å‹•ç•«ç¨å¿« */
      }
    }

    @media (max-width: 576px) {
      body {
        font-size: 12px;
      }

      .container, .calendar-container {
        max-width: 98vw;
        margin: 1vh auto;
        padding: 1rem;
      }

      h2, h3 {
        font-size: 1.1rem;
      }

      .form-control, .form-select, textarea {
        font-size: 0.8rem;
      }

      .success-message {
        font-size: 0.8rem;
        padding: 10px;
      }

      #calendar {
        font-size: 0.7rem;
      }

      .fc-daygrid-day-frame {
        min-height: 35px;
      }

      .fc-daygrid-day-number {
        font-size: 0.7rem;
      }

      .fc-daygrid-day.bg-booked .fc-daygrid-day-frame::after,
      .fc-daygrid-day.bg-booked.long-booking .fc-daygrid-day-frame::after {
        font-size: 0.9rem;
      }

      .fc-button {
        padding: 0.2rem 0.4rem !important;
        font-size: 0.7rem !important;
      }

      .fc-toolbar-title {
        font-size: 0.8rem !important;
      }

      .booking-info {
        font-size: 0.75rem;
      }

      .booking-info div {
        flex: 1 1 100%;
      }

      .booking-info svg {
        width: 0.9rem;
        height: 0.9rem;
      }

      .timeline-container {
        height: 50px;
      }

      .timeline-ticks {
        font-size: 0.65rem;
      }

      .timeline-bar {
        height: 14px;
        font-size: 0.6rem;
      }

      .animate__animated {
        --animate-duration: 0.3s; /* æ›´å°è¢å¹•å‹•ç•«æ›´å¿« */
      }
    }

    @media (min-width: 1200px) {
      .container, .calendar-container {
        max-width: 80vw;
      }

      h2, h3 {
        font-size: 1.8rem;
      }

      .form-control, .form-select, textarea {
        font-size: 1rem;
      }

      .btn-primary, .btn-secondary, .btn-danger {
        font-size: 1rem;
      }

      .success-message {
        font-size: 1rem;
      }

      .timeline-ticks {
        font-size: 0.8rem;
      }

      .timeline-bar {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container fade-in" id="login-container">
    <h2 class="text-center mb-4">ç™»å…¥</h2>
    <form id="login-form">
      <div class="mb-3">
        <label for="username" class="form-label">ç”¨æˆ¶å</label>
        <input type="text" class="form-control" id="username" required>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">å¯†ç¢¼</label>
        <input type="password" class="form-control" id="password" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">ç™»å…¥</button>
    </form>
  </div>

  <div class="container" id="booking-container" style="display: none;">
    <h2 class="text-center mb-4">æ–°å¯å¤§å…¬å‹™è»Šé ç´„</h2>
    <form id="booking-form">
      <div class="mb-3">
        <label for="department" class="form-label">éƒ¨é–€</label>
        <select class="form-select" id="department" required>
          <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
          <option value="ç¸½ç¶“ç†å®¤">ç¸½ç¶“ç†å®¤</option>
          <option value="æ”¹å–„äº‹å‹™å±€">æ”¹å–„äº‹å‹™å±€</option>
          <option value="è³‡è¨Šå®¤">è³‡è¨Šå®¤</option>
          <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
          <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
          <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
          <option value="å“ä¿éƒ¨">å“ä¿éƒ¨</option>
          <option value="ç”Ÿç®¡éƒ¨">ç”Ÿç®¡éƒ¨</option>
          <option value="å€‰ç®¡èª²">å€‰ç®¡èª²</option>
          <option value="é–‹ç™¼éƒ¨">é–‹ç™¼éƒ¨</option>
          <option value="ç”Ÿç”¢éƒ¨">ç”Ÿç”¢éƒ¨</option>
          <option value="åŠ å·¥èª²">åŠ å·¥èª²</option>
          <option value="çµ„è£èª²">çµ„è£èª²</option>
          <option value="ç”ŸæŠ€èª²">ç”ŸæŠ€èª²</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="name" class="form-label">å§“å</label>
        <input type="text" class="form-control" id="name" required>
      </div>
      <div class="mb-3">
        <label for="date" class="form-label">æ—¥æœŸ</label>
        <input type="date" class="form-control" id="date" required>
      </div>
      <div class="mb-3">
        <label for="start-time" class="form-label">é–‹å§‹æ™‚é–“</label>
        <select class="form-select" id="start-time" required>
          <option value="">è«‹é¸æ“‡é–‹å§‹æ™‚é–“</option>
          <option value="08:00">08:00</option>
          <option value="09:00">09:00</option>
          <option value="10:00">10:00</option>
          <option value="11:00">11:00</option>
          <option value="12:00">12:00</option>
          <option value="13:00">13:00</option>
          <option value="14:00">14:00</option>
          <option value="15:00">15:00</option>
          <option value="16:00">16:00</option>
          <option value="17:00">17:00</option>
          <option value="18:00">18:00</option>
          <option value="19:00">19:00</option>
          <option value="20:00">20:00</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="end-time" class="form-label">çµæŸæ™‚é–“</label>
        <select class="form-select" id="end-time" required>
          <option value="">è«‹é¸æ“‡çµæŸæ™‚é–“</option>
          <option value="09:00">09:00</option>
          <option value="10:00">10:00</option>
          <option value="11:00">11:00</option>
          <option value="12:00">12:00</option>
          <option value="13:00">13:00</option>
          <option value="14:00">14:00</option>
          <option value="15:00">15:00</option>
          <option value="16:00">16:00</option>
          <option value="17:00">17:00</option>
          <option value="18:00">18:00</option>
          <option value="19:00">19:00</option>
          <option value="20:00">20:00</option>
          <option value="21:00">21:00</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="reason" class="form-label">å…¬å‡ºåŸå› </label>
        <textarea class="form-control" id="reason" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary w-100">æäº¤é ç´„</button>
    </form>
    <button class="btn btn-secondary w-100 mt-3" id="logout">ç™»å‡º</button>
  </div>

  <div class="calendar-container" id="calendar-container" style="display: none;">
    <h3 class="text-center mb-4">é ç´„æ—¥æ›†</h3>
    <button class="btn btn-primary mt-2" id="refresh-calendar">åˆ·æ–°æ—¥æ›†</button>
    <div id="calendar"></div>
  </div>

  <!-- Modal for displaying bookings -->
  <div class="modal fade" id="bookingsModal" tabindex="-1" aria-labelledby="bookingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingsModalLabel">ç•¶å¤©é ç´„è©³æƒ…</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="loading">è¼‰å…¥ä¸­...</div>
          <div id="timeline-container" class="timeline-container" style="display: none;"></div>
          <div id="bookings-list"></div>
          <div id="no-bookings" class="no-bookings" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h10v2zm3 3H4v13h16V6zm-10 7h4v4h-4v-4z"/></svg>
            <p>ç•¶å¤©ç„¡é ç´„</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for cancel confirmation -->
  <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cancelModalLabel">ç¢ºèªå–æ¶ˆé ç´„</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>è«‹è¼¸å…¥å–æ¶ˆå¯†ç¢¼ä»¥ç¢ºèªå–æ¶ˆé ç´„</p>
          <form id="cancel-form">
            <div class="mb-3">
              <label for="cancel-password" class="form-label">å–æ¶ˆå¯†ç¢¼</label>
              <input type="password" class="form-control" id="cancel-password" required>
            </div>
            <input type="hidden" id="cancel-booking-id">
            <button type="submit" class="btn btn-danger w-100">ç¢ºèªå–æ¶ˆ</button>
          </form>
          <div id="success-message" class="success-message animate__animated">
            <p class="elegant-text">é ç´„å·²æˆåŠŸå–æ¶ˆï¼</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script>
    // å…¨å±€è®Šæ•¸å’Œå¸¸é‡
    const loginContainer = document.getElementById('login-container');
    const bookingContainer = document.getElementById('booking-container');
    const calendarContainer = document.getElementById('calendar-container');
    const loginForm = document.getElementById('login-form');
    const bookingForm = document.getElementById('booking-form');
    const cancelForm = document.getElementById('cancel-form');
    const logoutBtn = document.getElementById('logout');
    const dateInput = document.getElementById('date');
    const startTimeSelect = document.getElementById('start-time');
    const endTimeSelect = document.getElementById('end-time');
    const bookingsModal = new bootstrap.Modal(document.getElementById('bookingsModal'));
    const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));

    const timeSlots = [
      '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00',
      '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'
    ];

    const users = [
      { username: "S1234", password: "S1234" },
      { username: "00000", password: "00000" }
    ];

    // å¿«å–ç›¸é—œè®Šæ•¸
    let cachedBookings = null;
    let cacheTimestamp = null;
    const CACHE_DURATION = 60 * 1000; // 1 åˆ†é˜

    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);

    // å°‡æ™‚é–“è½‰ç‚ºåˆ†é˜æ•¸
    const toMinutes = (time) => {
      if (!time) return 0;
      const [hours, minutes] = time.split(':').map(Number);
      return hours * 60 + minutes;
    };

    // æª¢æŸ¥æ™‚é–“è¡çª
    const isConflict = (newStart, newEnd, existingStart, existingEnd) => {
      const newStartMin = toMinutes(newStart);
      const newEndMin = toMinutes(newEnd);
      const existingStartMin = toMinutes(existingStart);
      const existingEndMin = toMinutes(existingEnd);
      return !(newEndMin <= existingStartMin || newStartMin >= existingEndMin);
    };

    // ç™»å…¥è™•ç†
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      const user = users.find(u => u.username === username && u.password === password);
      if (user) {
        localStorage.setItem('token', 'mock-token');
        localStorage.setItem('username', username);
        loginContainer.style.display = 'none';
        bookingContainer.style.display = 'block';
        calendarContainer.style.display = 'block';
        bookingContainer.classList.add('fade-in', 'animate__animated', 'animate__fadeIn');
        calendarContainer.classList.add('fade-in', 'animate__animated', 'animate__fadeInUp');
        setupCalendarObserver();
      } else {
        alert('ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤');
      }
    }

    // ç™»å‡ºè™•ç†
    function handleLogout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      cachedBookings = null;
      cacheTimestamp = null;
      bookingContainer.style.display = 'none';
      calendarContainer.style.display = 'none';
      loginContainer.style.display = 'block';
      loginContainer.classList.add('fade-in', 'animate__animated', 'animate__fadeIn');
    }

    // ç²å–é ç´„è³‡æ–™
    async function fetchBookings() {
      const now = Date.now();
      if (cachedBookings && cacheTimestamp && (now - cacheTimestamp < CACHE_DURATION)) {
        console.log('Returning cached bookings:', cachedBookings);
        return cachedBookings;
      }

      try {
        const response = await fetch('/api/bookings');
        if (!response.ok) {
          throw new Error(`HTTP éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
        }
        const data = await response.json();
        cachedBookings = data;
        cacheTimestamp = now;
        console.log('Fetched bookings from server:', cachedBookings);
        return data;
      } catch (error) {
        console.error('Error fetching bookings:', error);
        alert('ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™ï¼š' + error.message);
        return [];
      }
    }

    // æäº¤é ç´„
    async function handleBookingSubmit(e) {
      e.preventDefault();
      const startTime = startTimeSelect.value;
      const endTime = endTimeSelect.value;
      const selectedDate = dateInput.value;

      const todayDate = new Date();
      todayDate.setHours(0, 0, 0, 0);
      const bookingDate = new Date(selectedDate);

      if (bookingDate < todayDate) {
        alert('ç„¡æ³•é ç´„éå»çš„æ—¥æœŸï¼Œè«‹é¸æ“‡æœªä¾†çš„æ—¥æœŸ');
        return;
      }

      if (!startTime || !endTime || startTime >= endTime) {
        alert('è«‹é¸æ“‡æœ‰æ•ˆçš„æ™‚é–“å€æ®µï¼ˆçµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼‰');
        return;
      }

      const bookings = await fetchBookings();
      const filteredBookings = bookings.filter(b => new Date(b.date).toISOString().split('T')[0] === selectedDate);

      let hasConflict = false;
      for (const booking of filteredBookings) {
        if (isConflict(startTime, endTime, booking.starttime.slice(0, 5), booking.endtime.slice(0, 5))) {
          hasConflict = true;
          break;
        }
      }

      if (hasConflict) {
        alert('æ‰€é¸æ™‚é–“å€æ®µèˆ‡ç¾æœ‰é ç´„è¡çªï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“');
        return;
      }

      const booking = {
        department: document.getElementById('department').value,
        name: document.getElementById('name').value,
        date: selectedDate,
        startTime: startTime + ':00',
        endTime: endTime + ':00',
        reason: document.getElementById('reason').value
      };

      try {
        const response = await fetch('/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(booking)
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'æäº¤é ç´„å¤±æ•—');
        }
        alert('é ç´„æäº¤æˆåŠŸ');
        bookingForm.reset();
        cachedBookings = null;
        cacheTimestamp = null;
        await updateCalendarColors();
        bookingContainer.classList.add('animate__animated', 'animate__fadeIn');
      } catch (error) {
        console.error('Error submitting booking:', error);
        alert('æäº¤é ç´„å¤±æ•—ï¼š' + error.message);
      }
    }

    // å–æ¶ˆé ç´„å¾Œæ›´æ–°è³‡æ–™çš„è¼”åŠ©å‡½æ•¸
    async function updateAfterCancel(selectedDate) {
      const bookings = await fetchBookings();
      const filteredBookings = bookings.filter(b => new Date(b.date).toISOString().split('T')[0] === selectedDate);
      renderBookingsList(filteredBookings, selectedDate);
      await updateCalendarColors();
    }

    // å–æ¶ˆé ç´„
    async function handleCancelSubmit(e) {
      e.preventDefault();
      const password = document.getElementById('cancel-password').value;
      const bookingId = document.getElementById('cancel-booking-id').value;
      const successMessage = document.getElementById('success-message');

      if (!bookingId) {
        alert('éŒ¯èª¤ï¼šç„¡æ•ˆçš„é ç´„ID');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        alert('éŒ¯èª¤ï¼šæœªæ‰¾åˆ°èº«ä»½é©—è­‰ä»¤ç‰Œï¼Œè«‹é‡æ–°ç™»éŒ„');
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        bookingContainer.style.display = 'none';
        calendarContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        loginContainer.classList.add('fade-in', 'animate__animated', 'animate__fadeIn');
        return;
      }

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'å–æ¶ˆé ç´„å¤±æ•—');
        }
        // é¡¯ç¤ºè³ªæ„Ÿå‹•ç•«ï¼ˆåŠ å¿«ï¼‰
        successMessage.style.display = 'block';
        successMessage.classList.remove('animate__fadeOut');
        successMessage.classList.add('animate__fadeInUp', 'animate__animated');
        // 1.5ç§’å¾Œéš±è—å‹•ç•«ä¸¦é—œé–‰æ¨¡æ…‹æ¡†
        setTimeout(() => {
          successMessage.classList.remove('animate__fadeInUp');
          successMessage.classList.add('animate__fadeOut');
          setTimeout(() => {
            successMessage.style.display = 'none';
            cancelModal.hide();
            document.getElementById('cancel-password').value = '';
            cachedBookings = null;
            cacheTimestamp = null;
            const selectedDate = document.getElementById('bookingsModalLabel').textContent.split(' ')[0];
            updateAfterCancel(selectedDate);
          }, 500); // ç¸®çŸ­æ·¡å‡ºæ™‚é–“
        }, 1500); // ç¸®çŸ­é¡¯ç¤ºæ™‚é–“
      } catch (error) {
        console.error('Error canceling booking:', error);
        alert('å–æ¶ˆé ç´„å¤±æ•—ï¼š' + error.message);
      }
    }

    // æ¸²æŸ“é ç´„åˆ—è¡¨
    function renderBookingsList(bookings, date) {
      const bookingsList = document.getElementById('bookings-list');
      const noBookings = document.getElementById('no-bookings');
      const timelineContainer = document.getElementById('timeline-container');

      if (bookings.length === 0) {
        bookingsList.style.display = 'none';
        timelineContainer.style.display = 'none';
        noBookings.style.display = 'block';
        noBookings.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h10v2zm3 3H4v13h16V6zm-10 7h4v4h-4v-4z"/></svg><p>ç•¶å¤©ç„¡é ç´„</p>';
        return;
      }

      bookingsList.style.display = 'block';
      timelineContainer.style.display = 'block';
      noBookings.style.display = 'none';

      const totalHours = timeSlots.length - 1;
      timelineContainer.innerHTML = `
        <div class="timeline">
          <div class="timeline-ticks">
            ${timeSlots.map(slot => `<div class="timeline-tick">${slot}</div>`).join('')}
          </div>
          ${bookings.map(booking => {
            const startIndex = timeSlots.indexOf(booking.starttime.slice(0, 5));
            const endIndex = timeSlots.indexOf(booking.endtime.slice(0, 5));
            const left = (startIndex / totalHours) * 100;
            const width = ((endIndex - startIndex) / totalHours) * 100;
            return `
              <div class="timeline-bar animate__animated animate__slideInRight" style="left: ${left}%; --final-width: ${width}%;" 
                   data-bs-toggle="tooltip" data-bs-placement="top"
                   title="${booking.department} (${booking.name}) ${booking.starttime.slice(0, 5)}-${booking.endtime.slice(0, 5)}: ${booking.reason}">
                ${booking.department}
              </div>`;
          }).join('')}
        </div>
      `;

      const tooltipTriggerList = timelineContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

      bookings.sort((a, b) => {
        const aSum = toMinutes(a.starttime) + toMinutes(a.endtime);
        const bSum = toMinutes(b.starttime) + toMinutes(b.endtime);
        return aSum - bSum;
      });

      bookingsList.innerHTML = bookings.map((booking, index) => {
        const bookingId = booking.id;
        if (!bookingId) {
          console.warn('é ç´„ç¼ºå°‘ id å±¬æ€§:', booking);
          return `
            <div class="booking-card animate__animated animate__slideInRight" style="animation-delay: ${index * 0.1}s;">
              <div class="booking-info">
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v3h2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V11a1 1 0 0 1 1-1h2V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v3h6V7a3 3 0 0 0-3-3zm-7 8v8h14v-8H5z"/></svg>
                  ${booking.department}
                </div>
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v3h2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V11a1 1 0 0 1 1-1h2V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v3h6V7a3 3 0 0 0-3-3zm-7 8v8h14v-8H5z"/></svg>
                  ${booking.name}
                </div>
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h10v2zm-1 5H8v2h8V8zm0 4H8v2h8v-2zm-8 4h8v2H8v-2z"/></svg>
                  ${booking.starttime.slice(0, 5)}-${booking.endtime.slice(0, 5)}
                </div>
                <div>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm1 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z"/></svg>
                  ${booking.reason}
                </div>
              </div>
              <span class="text-danger cancel-btn">ç„¡æ³•å–æ¶ˆ</span>
            </div>`;
        }
        return `
          <div class="booking-card animate__animated animate__slideInRight" style="animation-delay: ${index * 0.1}s;">
            <div class="booking-info">
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v3h2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V11a1 1 0 0 1 1-1h2V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v3h6V7a3 3 0 0 0-3-3zm-7 8v8h14v-8H5z"/></svg>
                ${booking.department}
              </div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v3h2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V11a1 1 0 0 1 1-1h2V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v3h6V7a3 3 0 0 0-3-3zm-7 8v8h14v-8H5z"/></svg>
                ${booking.name}
              </div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h10v2zm-1 5H8v2h8V8zm0 4H8v2h8v-2zm-8 4h8v2H8v-2z"/></svg>
                ${booking.starttime.slice(0, 5)}-${booking.endtime.slice(0, 5)}
              </div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm1 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z"/></svg>
                ${booking.reason}
              </div>
            </div>
            <button class="btn btn-danger cancel-btn" data-booking-id="${bookingId}" onclick="showCancelModal('${bookingId}')">å–æ¶ˆ</button>
          </div>`;
      }).join('');
    }

    // é¡¯ç¤ºå–æ¶ˆæ¨¡æ…‹æ¡†
    function showCancelModal(bookingId) {
      if (!bookingId) {
        console.error('showCancelModal æ¥æ”¶åˆ°ç„¡æ•ˆçš„ bookingId:', bookingId);
        alert('éŒ¯èª¤ï¼šç„¡æ³•é¡¯ç¤ºå–æ¶ˆè¦–çª—ï¼Œé ç´„IDç„¡æ•ˆ');
        return;
      }
      const cancelBookingIdInput = document.getElementById('cancel-booking-id');
      cancelBookingIdInput.value = bookingId;
      console.log('è¨­å®š cancel-booking-id ç‚º:', cancelBookingIdInput.value);
      cancelModal.show();
    }

    // åˆå§‹åŒ–æ—¥æ›†
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: new Date(),
        dateClick: async function(info) {
          const selectedDate = info.dateStr;
          document.querySelector('.loading').style.display = 'block';
          document.getElementById('bookings-list').style.display = 'none';
          document.getElementById('no-bookings').style.display = 'none';
          document.getElementById('timeline-container').style.display = 'none';
          try {
            const bookings = await fetchBookings();
            const filteredBookings = bookings.filter(b => new Date(b.date).toISOString().split('T')[0] === selectedDate);
            renderBookingsList(filteredBookings, selectedDate);
            document.getElementById('bookingsModalLabel').textContent = `${selectedDate} çš„é ç´„`;
            document.querySelector('.loading').style.display = 'none';
            bookingsModal.show();
          } catch (error) {
            console.error('è¼‰å…¥é ç´„éŒ¯èª¤:', error);
            document.querySelector('.loading').style.display = 'none';
            document.getElementById('no-bookings').style.display = 'block';
            document.getElementById('no-bookings').innerHTML = '<p>ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™ï¼š' + error.message + '</p>';
          }
        },
        events: [],
        datesSet: async function(info) {
          await updateCalendarColors();
        }
      });
      calendar.render();
      calendarEl._calendar = calendar;
      calendarEl.classList.add('animate__animated', 'animate__fadeInUp');

      calendarEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          const activeElement = document.activeElement;
          if (activeElement.classList.contains('fc-daygrid-day')) {
            const date = activeElement.getAttribute('data-date');
            calendar.select(date);
            activeElement.click();
          }
        }
      });
    }

    // æ›´æ–°æ—¥æ›†é¡è‰²
    async function updateCalendarColors() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('éŒ¯èª¤ï¼šæœªæ‰¾åˆ°èº«ä»½é©—è­‰ä»¤ç‰Œï¼Œè«‹é‡æ–°ç™»éŒ„');
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        bookingContainer.style.display = 'none';
        calendarContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        loginContainer.classList.add('fade-in', 'animate__animated', 'animate__fadeIn');
        return;
      }

      const bookings = await fetchBookings();
      console.log('Updating calendar with bookings:', bookings);
      const calendarEl = document.getElementById('calendar');
      const calendar = calendarEl._calendar;
      if (!calendar) {
        console.warn('Calendar not initialized');
        return;
      }

      calendar.getEvents().forEach(event => event.remove());

      bookings.forEach(booking => {
        const startTime = booking.starttime ? booking.starttime.slice(0, 5) : 'æœªçŸ¥';
        const endTime = booking.endtime ? booking.endtime.slice(0, 5) : 'æœªçŸ¥';
        const date = new Date(booking.date).toISOString().split('T')[0];
        const timeDiff = timeSlots.indexOf(endTime) - timeSlots.indexOf(startTime);
        const isLongBooking = timeDiff >= 4;

        calendar.addEvent({
          title: `${booking.department} (${startTime}-${endTime})`,
          start: date,
          allDay: true,
          classNames: ['bg-booked', isLongBooking ? 'long-booking' : ''],
          extendedProps: {
            department: booking.department,
            name: booking.name,
            reason: booking.reason
          }
        });
      });

      const bookedDates = [...new Set(bookings.map(b => new Date(b.date).toISOString().split('T')[0]))];
      console.log('Booked dates:', bookedDates);
      const todayStr = new Date().toISOString().split('T')[0];
      const days = document.querySelectorAll('.fc-daygrid-day');
      days.forEach(day => {
        const date = day.getAttribute('data-date');
        const dayFrame = day.querySelector('.fc-daygrid-day-frame');
        day.setAttribute('tabindex', '0');
        day.setAttribute('aria-label', `æ—¥æœŸ ${date}${bookedDates.includes(date) ? 'ï¼Œæœ‰é ç´„' : 'ï¼Œå¯é ç´„'}`);

        if (date === todayStr) {
          day.classList.add('today');
        } else {
          day.classList.remove('today');
        }

        if (bookedDates.includes(date)) {
          day.classList.add('bg-booked');
          day.classList.remove('available');
          const dayBookings = bookings.filter(b => new Date(b.date).toISOString().split('T')[0] === date);
          dayBookings.sort((a, b) => {
            const aSum = toMinutes(a.starttime) + toMinutes(a.endtime);
            const bSum = toMinutes(b.starttime) + toMinutes(b.endtime);
            return aSum - bSum;
          });
          if (dayFrame) {
            dayFrame.setAttribute('data-bs-toggle', 'tooltip');
            dayFrame.setAttribute('data-bs-placement', 'top');
            dayFrame.setAttribute('title', dayBookings
              .map(b => `${b.department} ${b.starttime.slice(0, 5)}-${b.endtime.slice(0, 5)}: ${b.reason}`)
              .join('\n'));
          }
        } else {
          day.classList.remove('bg-booked');
          day.classList.add('available');
          if (dayFrame) {
            dayFrame.style.backgroundColor = '';
            dayFrame.removeAttribute('data-bs-toggle');
            dayFrame.removeAttribute('data-bs-placement');
            dayFrame.removeAttribute('title');
          }
        }
      });

      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
      console.log('Calendar updated, booked dates rendered:', bookedDates);
    }

    // åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
    function setupCalendarObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initCalendar();
            observer.disconnect();
          }
        });
      }, { threshold: 0.1 });

      observer.observe(calendarContainer);
    }

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    bookingForm.addEventListener('submit', handleBookingSubmit);
    cancelForm.addEventListener('submit', handleCancelSubmit);
    document.getElementById('refresh-calendar').addEventListener('click', () => {
      console.log('Refresh calendar clicked');
      cachedBookings = null;
      cacheTimestamp = null;
      updateCalendarColors();
      document.getElementById('refresh-calendar').classList.add('animate__animated', 'animate__pulse');
      setTimeout(() => {
        document.getElementById('refresh-calendar').classList.remove('animate__animated', 'animate__pulse');
      }, 300);
    });
    dateInput.addEventListener('change', () => {
      // å¯åœ¨æ­¤è™•æ·»åŠ å‹•æ…‹æ™‚é–“é¸é …éæ¿¾ï¼ˆç•™å¾…æœªä¾†å„ªåŒ–ï¼‰
    });
  </script>
</body>
</html>
